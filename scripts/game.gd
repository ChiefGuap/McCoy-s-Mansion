extends Node2D

# --- TIMER STATE -------------------------------------------------
const START_TIME := 60                # 6 minutes
const LOW_TIME_THRESHOLD := 30         # 3 minute
const CRITICAL_TIME_THRESHOLD := 10    # last 60 seconds

var remaining_time_in_seconds := START_TIME
var _original_color: Color
var _pulse := 0.0

# -----------------------------------------------------------------
# This function is called when the scene first loads
func _ready():
	add_to_group("game_manager")  
	# Cutscene (your old code â€“ unchanged)
	$CutsceneManager.play_intro_cutscene()
	
	# Cache the original label color so we can restore it
	_original_color = $UI_Layer/TimerLabel.modulate
	
	# Start your timer text
	update_timer_label()


# Optional: haunted pulse effect when time is very low
func _process(delta: float) -> void:
	if remaining_time_in_seconds <= CRITICAL_TIME_THRESHOLD and remaining_time_in_seconds > 0:
		_pulse += delta * 5.0
		var s := 1.0 + 0.05 * sin(_pulse)
		$UI_Layer/TimerLabel.scale = Vector2(s, s)
	else:
		_pulse = 0.0
		$UI_Layer/TimerLabel.scale = Vector2.ONE


# This function was auto-generated by connecting the signal
func _on_timer_timeout():
	# Subtract one second
	remaining_time_in_seconds -= 1

	# Clamp so it never goes negative
	if remaining_time_in_seconds <= 0:
		remaining_time_in_seconds = 0
		$UI_Layer/Timer.stop()
		update_timer_label()
		# Add code here for what happens when time is up
		# Go to Game Over scene
		get_tree().change_scene_to_file("res://GameOver.tscn")

	else:
		# Update the label's text
		update_timer_label()


# This function formats the time to look nice
func update_timer_label():
	var minutes = remaining_time_in_seconds / 60.0
	var seconds = remaining_time_in_seconds % 60
	
	# Basic "mm:ss"
	$UI_Layer/TimerLabel.text = "%d:%02d" % [minutes, seconds]
	
	# Color changes for haunted vibe
	if remaining_time_in_seconds <= CRITICAL_TIME_THRESHOLD:
		# deep red when very low
		$UI_Layer/TimerLabel.modulate = Color(1, 0.2, 0.2)
	elif remaining_time_in_seconds <= LOW_TIME_THRESHOLD:
		# yellow / warning
		$UI_Layer/TimerLabel.modulate = Color(1, 0.8, 0.4)
	else:
		# normal color
		$UI_Layer/TimerLabel.modulate = _original_color


# Call this from your jumpscare code to remove 30 seconds
func apply_jumpscare_penalty():
	remaining_time_in_seconds -= 30
	if remaining_time_in_seconds < 0:
		remaining_time_in_seconds = 0
	update_timer_label()
